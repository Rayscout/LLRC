{% extends 'base.html' %}

{% block title %}职业发展与技能差距{% endblock %}

{% block content %}
<style>
  .cp-wrap{max-width:1100px;margin:20px auto;display:grid;gap:16px}
  .cp-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .cp-card{background:#fff;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.08);padding:16px}
  .cp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px}
  .cp-title{font-size:22px;font-weight:700;color:#111827}
  .cp-sub{color:#6b7280;font-size:13px}
  .cp-legend{display:flex;gap:8px;align-items:center;color:#374151;font-size:12px}
  .cp-pill{padding:4px 10px;border-radius:999px;background:#f3f4f6}
  .cp-steps{display:grid;gap:12px}
  .cp-step{display:flex;gap:12px;align-items:flex-start;background:#f9fafb;border-radius:10px;padding:12px}
  .cp-step .num{width:28px;height:28px;border-radius:50%;background:#2563eb;color:#fff;display:grid;place-items:center;font-weight:700}
  .cp-step .body{flex:1}
  .cp-step .body h4{margin:0 0 6px}
  .cp-badges{display:flex;flex-wrap:wrap;gap:6px}
  .cp-badge{font-size:12px;background:#eff6ff;color:#1d4ed8;border-radius:999px;padding:4px 8px}
  .cp-meter{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .cp-meter>div{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);width:0%}
  .cp-gaps{display:grid;gap:10px}
  .cp-gap{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px;border-radius:10px}
  .cp-gap strong{margin-right:6px}
  .cp-actions{display:flex;gap:10px;justify-content:flex-end}
  .cp-btn{padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
  .cp-btn.primary{background:#2563eb;color:#fff}
  .cp-btn.neutral{background:#f3f4f6;color:#111}
  .cp-select{min-width:180px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  body.dark .cp-card{background:#1f2937;color:#e5e7eb}
  body.dark .cp-step{background:#111827}
  body.dark .cp-gap{background:#2b190b;border-color:#b45309;color:#fde68a}
</style>

<div class="cp-wrap">
  <div class="cp-grid">
    <div class="cp-card">
      <div class="cp-header">
        <div>
          <div class="cp-title">职业雷达与成长进度</div>
          <div class="cp-sub">基于当前简历信息的模拟评估（仅前端展示）</div>
        </div>
        <div class="cp-legend">
          <span class="cp-pill">当前水平</span>
          <span class="cp-pill">目标岗位要求</span>
        </div>
      </div>
      <canvas id="cpRadar" height="260"></canvas>
      <div style="margin-top:12px">
        <div class="cp-meter"><div id="cpProgress"></div></div>
        <div class="cp-sub" style="margin-top:6px">总体达成度：<span id="cpProgressText">0%</span></div>
      </div>
    </div>

    <div class="cp-card">
      <div class="cp-header">
        <div class="cp-title">目标岗位</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="cp-sub">选择目标：</span>
          <select id="cpRoleSelect" class="cp-select"></select>
        </div>
      </div>
      <div class="cp-steps" id="cpTargets"></div>
    </div>
  </div>

  <div class="cp-card">
    <div class="cp-header">
      <div>
        <div class="cp-title">技能差距与学习建议</div>
        <div class="cp-sub">以下建议为示例数据，帮助你快速制定学习路线</div>
      </div>
    </div>
    <div class="cp-gaps" id="cpGaps"></div>
    <div class="cp-actions" style="margin-top:12px">
      <a class="cp-btn neutral" href="{{ url_for('smartrecruit.candidate.jobs.job_search') }}">查看相关职位</a>
      <button class="cp-btn primary" id="cpPlan">生成学习计划</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function(){
    const USER_ID = {{ (user.id if user else 'null') | tojson }};
    const STORAGE_KEY = `careerTargetRole_${USER_ID ?? 'guest'}`;

    // 维度与当前评估（示例）
    const dimensions = ['编程基础','后端框架','前端技能','云与DevOps','数据库','沟通与协作'];
    const current = [68, 55, 60, 40, 62, 70];

    // 目标岗位库（示例）
    const rolesCatalog = {
      backend:  { label:'后端工程师', level:'中级', target:[85,80,60,65,78,70], skills:['Python','Flask/Django','SQL','微服务','容器化'] },
      fullstack: { label:'全栈工程师', level:'中级', target:[80,70,75,60,72,72], skills:['React','Node.js','API 设计','数据库','CI/CD'] },
      cloud:    { label:'云平台工程师', level:'初级', target:[70,55,55,75,65,70], skills:['Linux','Docker','云基础','监控','自动化脚本'] },
      data:     { label:'数据工程师', level:'初级', target:[75,65,50,55,80,68], skills:['Python','ETL','SQL/NoSQL','数据建模','批流一体'] }
    };

    // 初始化选择框
    const roleSelect = document.getElementById('cpRoleSelect');
    roleSelect.innerHTML = Object.entries(rolesCatalog).map(([key,meta])=>`<option value="${key}">${meta.label} · ${meta.level}</option>`).join('');
    const saved = localStorage.getItem(STORAGE_KEY) || 'backend';
    roleSelect.value = rolesCatalog[saved] ? saved : 'backend';

    // 图表
    const ctx = document.getElementById('cpRadar').getContext('2d');
    const radarChart = new Chart(ctx, {
      type: 'radar',
      data: { labels: dimensions, datasets: [
        { label:'当前', data: current, backgroundColor:'rgba(37,99,235,0.2)', borderColor:'#2563eb', pointBackgroundColor:'#2563eb' },
        { label:'目标', data: rolesCatalog[roleSelect.value].target, backgroundColor:'rgba(34,197,94,0.15)', borderColor:'#22c55e', pointBackgroundColor:'#22c55e' }
      ]},
      options: { responsive: true, scales: { r: { suggestedMin: 0, suggestedMax: 100, angleLines:{ color:'#e5e7eb' }, grid:{ color:'#e5e7eb' } } }, plugins: { legend: { labels: { color: getComputedStyle(document.body).getPropertyValue('--text-color') || '#111827' } } } }
    });

    const cpProgress = document.getElementById('cpProgress');
    const cpProgressText = document.getElementById('cpProgressText');
    function updateProgress(target){
      const p = Math.round(current.reduce((a,b)=>a+b,0)/target.reduce((a,b)=>a+b,0)*100);
      cpProgress.style.width = p + '%';
      cpProgressText.textContent = p + '%';
    }

    // 目标岗位卡片与差距
    const cpTargets = document.getElementById('cpTargets');
    const cpGaps = document.getElementById('cpGaps');
    function renderTargetsPanel(roleKey){
      const meta = rolesCatalog[roleKey];
      cpTargets.innerHTML = `
        <div class="cp-step">
          <div class="num">1</div>
          <div class="body">
            <h4>${meta.label} · ${meta.level}</h4>
            <div class="cp-badges">${meta.skills.map(s=>`<span class=\"cp-badge\">${s}</span>`).join('')}</div>
          </div>
        </div>`;
    }
    function renderGaps(roleKey){
      const meta = rolesCatalog[roleKey];
      const target = meta.target;
      const gaps = [
        { name:'后端框架', idx:1, tips:['系统学习 Flask/Django','构建含认证/ORM/测试的服务','阅读优秀项目结构'] },
        { name:'云与DevOps', idx:3, tips:['掌握 Docker 与镜像优化','熟悉 CI/CD 并实操','入门云服务部署与监控'] },
        { name:'前端技能', idx:2, tips:['组件化与状态管理','响应式与可访问性','打包优化与构建工具'] },
        { name:'数据库', idx:4, tips:['深化 SQL 与索引优化','理解事务与锁','了解 NoSQL 与场景'] }
      ].map(g=>({ ...g, gap: Math.max(0, target[g.idx] - current[g.idx]) })).filter(g=>g.gap>0).sort((a,b)=>b.gap-a.gap);

      if(gaps.length===0){
        cpGaps.innerHTML = '<div class="cp-sub">已达到当前目标要求，继续保持并拓展深度。</div>';
      } else {
        cpGaps.innerHTML = gaps.map(g=>`
          <div class="cp-gap">
            <div><strong>${g.name}</strong>差距约 <strong>${g.gap}</strong> 分</div>
            <div class="cp-sub" style="margin-top:6px">建议：${g.tips.join('；')}</div>
          </div>
        `).join('');
      }
    }

    // 初始化渲染与动画
    requestAnimationFrame(()=>{ cpProgress.style.width = '0%'; });
    setTimeout(()=>{ updateProgress(rolesCatalog[roleSelect.value].target); }, 300);
    renderTargetsPanel(roleSelect.value);
    renderGaps(roleSelect.value);

    // 监听选择改变
    roleSelect.addEventListener('change', ()=>{
      const key = roleSelect.value;
      localStorage.setItem(STORAGE_KEY, key);
      radarChart.data.datasets[1].data = rolesCatalog[key].target;
      radarChart.update();
      updateProgress(rolesCatalog[key].target);
      renderTargetsPanel(key);
      renderGaps(key);
    });

    // 学习计划（基于选择角色）
    document.getElementById('cpPlan').addEventListener('click',()=>{
      const meta = rolesCatalog[roleSelect.value];
      alert(`已为你生成 4 周 ${meta.label} 学习计划（示例）：\n\n第1周：核心基础与项目骨架\n第2周：数据库/接口或前端模块实践\n第3周：容器化与CI/CD落地\n第4周：监控与性能优化，撰写文档`);
    });
  })();
</script>
{% endblock %}


