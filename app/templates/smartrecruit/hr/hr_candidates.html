{% extends 'base.html' %}

{% block title %}候选人管理{% endblock %}

{% block content %}
<div class="candidates-management ios-style">
    <!-- 页面标题和统计 -->
    <div class="page-header">
        <div class="header-content">
            <h1><i class="uil uil-users-alt"></i> 候选人管理</h1>
            <p>管理所有候选人信息、跟踪申请状态、安排面试</p>
        </div>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-number">{{ candidates|length }}</div>
                <div class="stat-label">总候选人</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ candidates|selectattr('status', 'equalto', 'interview')|list|length }}</div>
                <div class="stat-label">面试中</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ candidates|selectattr('status', 'equalto', 'offer')|list|length }}</div>
                <div class="stat-label">已发Offer</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ candidates|selectattr('status', 'equalto', 'hired')|list|length }}</div>
                <div class="stat-label">已入职</div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索工具栏 -->
    <div class="toolbar">
        <div class="search-section">
            <div class="search-box">
                <i class="uil uil-search"></i>
                <input type="text" id="candidate-search" placeholder="搜索候选人姓名或技能...">
            </div>
        </div>
        
        <div class="filters-section">
            <div class="filter-group">
                <label>状态筛选</label>
                <select id="status-filter" class="filter-select">
                    <option value="">所有状态</option>
                    <option value="applied">投递</option>
                    <option value="interview">面试</option>
                    <option value="offer">Offer</option>
                    <option value="hired">入职</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>技能匹配度</label>
                <select id="skills-filter" class="filter-select">
                    <option value="">所有匹配度</option>
                    <option value="90-100">90%以上</option>
                    <option value="80-89">80-89%</option>
                    <option value="70-79">70-79%</option>
                    <option value="0-69">70%以下</option>
                </select>
            </div>
        </div>
        
        <div class="actions-section">
            <button class="btn-secondary" onclick="exportCandidates()">
                <i class="uil uil-export"></i> 导出数据
            </button>
            <button class="btn-primary" onclick="bulkActions()">
                <i class="uil uil-check-square"></i> 批量操作
            </button>
        </div>
    </div>

    <!-- 候选人表格 -->
    <div class="candidates-table-container">
        <table class="candidates-table" id="candidates-table">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>技能匹配度%</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for candidate in candidates %}
                <tr class="candidate-row" data-id="{{ candidate.id }}" data-status="{{ candidate.status }}" data-skills="{{ candidate.skills_match }}" data-name="{{ candidate.first_name }} {{ candidate.last_name }}">
                    <td class="candidate-name-cell">
                        <div class="candidate-info">
                            <div class="candidate-avatar">
                                {% if candidate.profile_photo %}
                                    <img src="{{ url_for('static', filename='uploads/photos/' + candidate.profile_photo) }}" alt="头像">
                                {% else %}
                                    <div class="avatar-placeholder">
                                        {{ (candidate.first_name + ' ' + candidate.last_name)[0]|upper if candidate.first_name else 'U' }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="candidate-details">
                                <div class="candidate-name">{{ candidate.first_name }} {{ candidate.last_name }}</div>
                                <div class="candidate-email">{{ candidate.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="skills-match-cell">
                        <div class="skills-match">
                            <div class="match-percentage">{{ candidate.skills_match }}%</div>
                            <div class="match-bar">
                                <div class="match-fill" style="width: {{ candidate.skills_match }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="status-cell">
                        <span class="status-badge {{ candidate.status }}">
                            {% if candidate.status == 'applied' %}投递
                            {% elif candidate.status == 'interview' %}面试
                            {% elif candidate.status == 'offer' %}Offer
                            {% elif candidate.status == 'hired' %}入职
                            {% else %}{{ candidate.status }}
                            {% endif %}
                        </span>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-action primary" onclick="viewCandidate({{ candidate.id }})" title="查看">
                                <i class="uil uil-eye"></i>
                            </button>
                            <button class="btn-action" onclick="compareCandidate({{ candidate.id }})" title="比较">
                                <i class="uil uil-chart-bar"></i>
                            </button>
                            <button class="btn-action" onclick="scheduleInterview({{ candidate.id }})" title="安排面试">
                                <i class="uil uil-calendar-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 空状态 -->
    <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">
            <i class="uil uil-users-alt"></i>
        </div>
        <h3>暂无候选人</h3>
        <p>当前没有找到符合条件的候选人，请尝试调整筛选条件</p>
        <button class="btn-primary" onclick="resetFilters()">
            <i class="uil uil-refresh"></i> 重置筛选
        </button>
    </div>

    <!-- 分页控件 -->
    <div class="pagination" id="pagination">
        <div class="pagination-info">
            <span>显示 1-{{ candidates|length }} 条，共 {{ candidates|length }} 条记录</span>
        </div>
        <div class="pagination-controls">
            <button class="btn-page" onclick="previousPage()" disabled>
                <i class="uil uil-angle-left"></i> 上一页
            </button>
            <div class="page-numbers">
                <span class="page-number active">1</span>
            </div>
            <button class="btn-page" onclick="nextPage()" disabled>
                下一页 <i class="uil uil-angle-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- 候选人详情模态框 -->
<div id="candidate-modal" class="modal">
    <div class="modal-content candidate-detail-modal">
        <div class="modal-header">
            <h3>候选人详情</h3>
            <button class="modal-close" onclick="closeModal()">
                <i class="uil uil-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- 动态加载候选人详情 -->
        </div>
    </div>
</div>

<!-- 候选人比较模态框 -->
<div id="compare-modal" class="modal">
    <div class="modal-content compare-modal">
        <div class="modal-header">
            <h3>候选人比较</h3>
            <button class="modal-close" onclick="closeCompareModal()">
                <i class="uil uil-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="compare-selection">
                <div class="compare-candidate">
                    <label>候选人 1</label>
                    <select id="candidate1-select" class="compare-select">
                        <option value="">选择候选人</option>
                        {% for candidate in candidates %}
                        <option value="{{ candidate.id }}" data-name="{{ candidate.first_name }} {{ candidate.last_name }}">
                            {{ candidate.first_name }} {{ candidate.last_name }} ({{ candidate.skills_match }}%)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="compare-candidate">
                    <label>候选人 2</label>
                    <select id="candidate2-select" class="compare-select">
                        <option value="">选择候选人</option>
                        {% for candidate in candidates %}
                        <option value="{{ candidate.id }}" data-name="{{ candidate.first_name }} {{ candidate.last_name }}">
                            {{ candidate.first_name }} {{ candidate.last_name }} ({{ candidate.skills_match }}%)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button class="btn-primary" onclick="compareCandidates()">
                    <i class="uil uil-chart-bar"></i> 开始比较
                </button>
            </div>
            <div class="compare-results" id="compare-results" style="display: none;">
                <!-- 比较结果将在这里显示 -->
            </div>
        </div>
    </div>
</div>

<!-- 批量操作模态框 -->
<div id="bulk-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>批量操作</h3>
            <button class="modal-close" onclick="closeBulkModal()">
                <i class="uil uil-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="bulk-actions">
                <button class="btn-action-bulk" onclick="bulkScheduleInterview()">
                    <i class="uil uil-calendar-alt"></i> 批量安排面试
                </button>
                <button class="btn-action-bulk" onclick="bulkSendEmail()">
                    <i class="uil uil-envelope"></i> 批量发送邮件
                </button>
                <button class="btn-action-bulk" onclick="bulkExport()">
                    <i class="uil uil-export"></i> 批量导出
                </button>
                <button class="btn-action-bulk danger" onclick="bulkReject()">
                    <i class="uil uil-times"></i> 批量拒绝
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 导出选项模态框 -->
<div id="export-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>导出候选人数据</h3>
            <button class="modal-close" onclick="closeExportModal()">
                <i class="uil uil-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="export-options">
                <div class="export-format">
                    <label>导出格式</label>
                    <select id="export-format" class="export-select">
                        <option value="excel">Excel (.xlsx)</option>
                        <option value="csv">CSV (.csv)</option>
                        <option value="pdf">PDF (.pdf)</option>
                    </select>
                </div>
                <div class="export-fields">
                    <label>导出字段</label>
                    <div class="field-checkboxes">
                        <label class="field-checkbox">
                            <input type="checkbox" value="name" checked> 姓名
                        </label>
                        <label class="field-checkbox">
                            <input type="checkbox" value="email" checked> 邮箱
                        </label>
                        <label class="field-checkbox">
                            <input type="checkbox" value="skills" checked> 技能匹配度
                        </label>
                        <label class="field-checkbox">
                            <input type="checkbox" value="status" checked> 状态
                        </label>
                        <label class="field-checkbox">
                            <input type="checkbox" value="experience" checked> 工作经验
                        </label>
                        <label class="field-checkbox">
                            <input type="checkbox" value="education" checked> 教育背景
                        </label>
                        <label class="field-checkbox">
                            <input type="checkbox" value="applied_date" checked> 申请日期
                        </label>
                    </div>
                </div>
                <div class="export-filter">
                    <label>导出范围</label>
                    <select id="export-filter" class="export-select">
                        <option value="all">所有候选人</option>
                        <option value="filtered">当前筛选结果</option>
                        <option value="selected">选中的候选人</option>
                    </select>
                </div>
            </div>
            <div class="export-actions">
                <button class="btn-secondary" onclick="closeExportModal()">取消</button>
                <button class="btn-primary" onclick="executeExport()">
                    <i class="uil uil-download-alt"></i> 开始导出
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.candidates-management.ios-style {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* iOS风格变量 */
:root {
    --ios-bg: #f2f2f7;
    --ios-card: #ffffff;
    --ios-border: #e5e5ea;
    --ios-text: #000000;
    --ios-text-secondary: #8e8e93;
    --ios-blue: #007aff;
    --ios-green: #34c759;
    --ios-orange: #ff9500;
    --ios-red: #ff3b30;
    --ios-gray: #8e8e93;
    --ios-radius: 12px;
    --ios-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* 页面标题和统计 */
.page-header {
    background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
    color: white;
    padding: 30px;
    border-radius: var(--ios-radius);
    margin-bottom: 30px;
    box-shadow: var(--ios-shadow);
}

.header-content h1 {
    font-size: 28px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
}

.header-content p {
    font-size: 16px;
    opacity: 0.9;
    margin: 0;
}

.header-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 20px;
    margin-top: 25px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: var(--ios-radius);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-number {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
}

/* 工具栏 */
.toolbar {
    background: var(--ios-card);
    padding: 20px;
    border-radius: var(--ios-radius);
    box-shadow: var(--ios-shadow);
    margin-bottom: 25px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: center;
    border: 1px solid var(--ios-border);
}

.search-section {
    flex: 1;
    min-width: 300px;
}

.search-box {
    position: relative;
    width: 100%;
}

.search-box i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--ios-text-secondary);
}

.search-box input {
    width: 100%;
    padding: 12px 16px 12px 45px;
    border: 1px solid var(--ios-border);
    border-radius: var(--ios-radius);
    font-size: 16px;
    transition: all 0.3s;
    background: var(--ios-bg);
}

.search-box input:focus {
    outline: none;
    border-color: var(--ios-blue);
    background: var(--ios-card);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.filters-section {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-size: 12px;
    font-weight: 500;
    color: var(--ios-text-secondary);
}

.filter-select {
    padding: 8px 12px;
    border: 1px solid var(--ios-border);
    border-radius: var(--ios-radius);
    font-size: 14px;
    background: var(--ios-card);
    color: var(--ios-text);
}

.actions-section {
    display: flex;
    gap: 12px;
}

/* 候选人表格 */
.candidates-table-container {
    background: var(--ios-card);
    border-radius: var(--ios-radius);
    box-shadow: var(--ios-shadow);
    overflow: hidden;
    border: 1px solid var(--ios-border);
    margin-bottom: 25px;
}

.candidates-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--ios-card);
}

.candidates-table th {
    background: var(--ios-bg);
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    color: var(--ios-text);
    border-bottom: 1px solid var(--ios-border);
    font-size: 14px;
}

.candidates-table td {
    padding: 16px 20px;
    border-bottom: 1px solid var(--ios-border);
    vertical-align: middle;
}

.candidates-table tr:hover {
    background: var(--ios-bg);
}

.candidate-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.candidate-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.candidate-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--ios-blue), #5856d6);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 600;
}

.candidate-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.candidate-name {
    font-weight: 600;
    color: var(--ios-text);
    font-size: 16px;
}

.candidate-email {
    color: var(--ios-text-secondary);
    font-size: 14px;
}

.skills-match {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.match-percentage {
    font-weight: 600;
    color: var(--ios-green);
    font-size: 14px;
}

.match-bar {
    width: 100%;
    height: 6px;
    background: var(--ios-bg);
    border-radius: 3px;
    overflow: hidden;
}

.match-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--ios-green), #30d158);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    display: inline-block;
}

.status-badge.applied { background: #e3f2fd; color: #1976d2; }
.status-badge.interview { background: #fff3e0; color: #f57c00; }
.status-badge.offer { background: #e8f5e8; color: #388e3c; }
.status-badge.hired { background: #e8f5e8; color: #388e3c; }

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-action {
    padding: 8px;
    border: none;
    border-radius: var(--ios-radius);
    background: var(--ios-bg);
    color: var(--ios-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    border: 1px solid var(--ios-border);
}

.btn-action:hover {
    background: var(--ios-blue);
    color: white;
    transform: translateY(-1px);
    box-shadow: var(--ios-shadow);
}

.btn-action.primary {
    background: var(--ios-blue);
    color: white;
    border-color: var(--ios-blue);
}

.btn-action.primary:hover {
    background: #0056cc;
}

/* 按钮样式 */
.btn-primary {
    background: var(--ios-blue);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--ios-radius);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary:hover {
    background: #0056cc;
    transform: translateY(-1px);
    box-shadow: var(--ios-shadow);
}

.btn-secondary {
    background: var(--ios-card);
    color: var(--ios-text);
    border: 1px solid var(--ios-border);
    padding: 12px 20px;
    border-radius: var(--ios-radius);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary:hover {
    background: var(--ios-bg);
    transform: translateY(-1px);
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--ios-text-secondary);
}

.empty-icon {
    font-size: 64px;
    color: var(--ios-border);
    margin-bottom: 20px;
}

.empty-state h3 {
    font-size: 20px;
    margin-bottom: 10px;
    color: var(--ios-text);
}

.empty-state p {
    margin-bottom: 25px;
}

/* 分页 */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--ios-card);
    padding: 20px;
    border-radius: var(--ios-radius);
    box-shadow: var(--ios-shadow);
    border: 1px solid var(--ios-border);
}

.pagination-info {
    color: var(--ios-text-secondary);
    font-size: 14px;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-page {
    padding: 8px 16px;
    border: 1px solid var(--ios-border);
    background: var(--ios-card);
    color: var(--ios-text);
    border-radius: var(--ios-radius);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-page:hover:not(:disabled) {
    background: var(--ios-bg);
    transform: translateY(-1px);
}

.btn-page:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-numbers {
    display: flex;
    gap: 8px;
}

.page-number {
    padding: 8px 12px;
    border: 1px solid var(--ios-border);
    background: var(--ios-card);
    color: var(--ios-text);
    border-radius: var(--ios-radius);
    cursor: pointer;
    transition: all 0.2s;
}

.page-number.active {
    background: var(--ios-blue);
    color: white;
    border-color: var(--ios-blue);
}

.page-number:hover:not(.active) {
    background: var(--ios-bg);
}

/* 模态框 */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: var(--ios-card);
    margin: 5% auto;
    padding: 0;
    border-radius: var(--ios-radius);
    width: 90%;
    max-width: 600px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

.candidate-detail-modal {
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.compare-modal {
    max-width: 900px;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--ios-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: var(--ios-card);
    z-index: 1;
}

.modal-header h3 {
    margin: 0;
    color: var(--ios-text);
    font-size: 18px;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--ios-text-secondary);
    padding: 4px;
    border-radius: 50%;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--ios-bg);
    color: var(--ios-text);
}

.modal-body {
    padding: 20px;
}

/* 候选人详情样式 */
.candidate-detail-content {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.candidate-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: var(--ios-bg);
    border-radius: var(--ios-radius);
}

.candidate-header-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    overflow: hidden;
}

.candidate-header-info h4 {
    margin: 0 0 8px 0;
    font-size: 20px;
    color: var(--ios-text);
}

.candidate-header-info p {
    margin: 0;
    color: var(--ios-text-secondary);
}

.detail-section {
    background: var(--ios-card);
    border: 1px solid var(--ios-border);
    border-radius: var(--ios-radius);
    overflow: hidden;
}

.detail-section-header {
    padding: 16px 20px;
    background: var(--ios-bg);
    border-bottom: 1px solid var(--ios-border);
    font-weight: 600;
    color: var(--ios-text);
}

.detail-section-content {
    padding: 20px;
}

.skills-radar {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    background: var(--ios-bg);
    border-radius: var(--ios-radius);
}

.skills-radar-placeholder {
    text-align: center;
    color: var(--ios-text-secondary);
}

.skills-radar-placeholder i {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--ios-border);
}

.resume-content {
    max-height: 400px;
    overflow-y: auto;
    background: var(--ios-bg);
    border-radius: var(--ios-radius);
    padding: 20px;
}

.resume-content-placeholder {
    text-align: center;
    color: var(--ios-text-secondary);
    padding: 40px 20px;
}

.interview-records {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.interview-record {
    padding: 16px;
    background: var(--ios-bg);
    border-radius: var(--ios-radius);
    border: 1px solid var(--ios-border);
}

.interview-record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.interview-date {
    font-weight: 600;
    color: var(--ios-text);
}

.interview-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.interview-status.scheduled { background: #e3f2fd; color: #1976d2; }
.interview-status.completed { background: #e8f5e8; color: #388e3c; }
.interview-status.cancelled { background: #ffebee; color: #d32f2f; }

.interview-notes {
    color: var(--ios-text-secondary);
    font-size: 14px;
    line-height: 1.5;
}

/* 候选人比较样式 */
.compare-selection {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 20px;
    align-items: end;
    margin-bottom: 30px;
    padding: 20px;
    background: var(--ios-bg);
    border-radius: var(--ios-radius);
}

.compare-candidate {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.compare-candidate label {
    font-weight: 500;
    color: var(--ios-text);
    font-size: 14px;
}

.compare-select {
    padding: 12px;
    border: 1px solid var(--ios-border);
    border-radius: var(--ios-radius);
    background: var(--ios-card);
    color: var(--ios-text);
    font-size: 14px;
}

.compare-results {
    margin-top: 20px;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--ios-card);
    border-radius: var(--ios-radius);
    overflow: hidden;
    border: 1px solid var(--ios-border);
}

.comparison-table th,
.comparison-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--ios-border);
}

.comparison-table th {
    background: var(--ios-bg);
    font-weight: 600;
    color: var(--ios-text);
}

.comparison-table td {
    color: var(--ios-text);
}

.comparison-table tr:hover {
    background: var(--ios-bg);
}

.comparison-highlight {
    background: rgba(0, 122, 255, 0.1);
    font-weight: 600;
}

/* 导出模态框样式 */
.export-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 24px;
}

.export-format,
.export-filter {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.export-format label,
.export-filter label {
    font-weight: 500;
    color: var(--ios-text);
    font-size: 14px;
}

.export-select {
    padding: 12px;
    border: 1px solid var(--ios-border);
    border-radius: var(--ios-radius);
    background: var(--ios-card);
    color: var(--ios-text);
    font-size: 14px;
}

.export-fields {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.export-fields label {
    font-weight: 500;
    color: var(--ios-text);
    font-size: 14px;
}

.field-checkboxes {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    padding: 16px;
    background: var(--ios-bg);
    border-radius: var(--ios-radius);
    border: 1px solid var(--ios-border);
}

.field-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--ios-text);
    cursor: pointer;
}

.field-checkbox input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--ios-blue);
}

.export-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 20px;
    border-top: 1px solid var(--ios-border);
}

/* 批量操作样式 */
.bulk-actions {
    display: grid;
    gap: 12px;
}

.btn-action-bulk {
    padding: 16px;
    border: 1px solid var(--ios-border);
    background: var(--ios-card);
    color: var(--ios-text);
    border-radius: var(--ios-radius);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 16px;
    font-weight: 500;
}

.btn-action-bulk:hover {
    background: var(--ios-bg);
    transform: translateY(-1px);
    box-shadow: var(--ios-shadow);
}

.btn-action-bulk.danger:hover {
    background: #ffebee;
    color: var(--ios-red);
    border-color: var(--ios-red);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .candidates-management.ios-style {
        padding: 15px;
    }
    
    .page-header {
        padding: 20px;
    }
    
    .header-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-section {
        min-width: auto;
    }
    
    .filters-section {
        justify-content: center;
    }
    
    .candidates-table {
        font-size: 14px;
    }
    
    .candidates-table th,
    .candidates-table td {
        padding: 12px 16px;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 4px;
    }
    
    .pagination {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .candidate-detail-modal,
    .compare-modal {
        width: 95%;
        margin: 5% auto;
    }
    
    .compare-selection {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .export-options {
        gap: 16px;
    }
    
    .field-checkboxes {
        grid-template-columns: 1fr;
    }
    
    .export-actions {
        flex-direction: column;
        gap: 12px;
    }
    
    .export-actions .btn-primary,
    .export-actions .btn-secondary {
        width: 100%;
        justify-content: center;
    }
    
    .candidate-header {
        flex-direction: column;
        text-align: center;
        gap: 12px;
    }
    
    .detail-section-content > div {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .skills-radar {
        min-height: 200px;
    }
    
    .resume-content {
        max-height: 300px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 搜索功能
    const searchInput = document.getElementById('candidate-search');
    searchInput.addEventListener('input', function() {
        filterCandidates();
    });

    // 筛选功能
    const filters = ['status-filter', 'skills-filter'];
    filters.forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', filterCandidates);
    });
});

function filterCandidates() {
    const searchTerm = document.getElementById('candidate-search').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const skillsFilter = document.getElementById('skills-filter').value;

    const rows = document.querySelectorAll('.candidate-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name.toLowerCase();
        const status = row.dataset.status;
        const skills = parseInt(row.dataset.skills);

        let show = true;

        // 搜索过滤
        if (searchTerm && !name.includes(searchTerm)) {
            show = false;
        }

        // 状态过滤
        if (statusFilter && status !== statusFilter) {
            show = false;
        }

        // 技能匹配度过滤
        if (skillsFilter) {
            const [min, max] = skillsFilter.split('-').map(Number);
            if (max && (skills < min || skills > max)) {
                show = false;
            } else if (!max && skills < min) {
                show = false;
            }
        }

        row.style.display = show ? 'table-row' : 'none';
        if (show) visibleCount++;
    });

    // 显示/隐藏空状态
    const emptyState = document.getElementById('empty-state');
    const candidatesTable = document.getElementById('candidates-table');
    
    if (visibleCount === 0) {
        emptyState.style.display = 'block';
        candidatesTable.style.display = 'none';
    } else {
        emptyState.style.display = 'none';
        candidatesTable.style.display = 'table';
    }
}

function viewCandidate(id) {
    // 打开候选人详情模态框
    const modal = document.getElementById('candidate-modal');
    const modalBody = document.getElementById('modal-body');
    
    // 模拟候选人数据 - 实际应用中应该从后端获取
    const candidateData = {
        id: id,
        name: '候选人姓名',
        email: 'candidate@example.com',
        skills: ['JavaScript', 'Python', 'React', 'Node.js', 'MongoDB'],
        skillsMatch: 85,
        experience: '3-5年',
        education: '计算机科学学士',
        appliedDate: '2024-01-15',
        status: '面试中',
        resume: '这里是候选人的简历内容...',
        interviews: [
            {
                date: '2024-01-20',
                status: 'completed',
                notes: '第一轮技术面试完成，候选人表现良好，技术基础扎实。'
            },
            {
                date: '2024-01-25',
                status: 'scheduled',
                notes: '第二轮面试已安排，将进行团队协作能力评估。'
            }
        ]
    };
    
    // 生成候选人详情HTML
    modalBody.innerHTML = generateCandidateDetailHTML(candidateData);
    modal.style.display = 'block';
}

function generateCandidateDetailHTML(candidate) {
    return `
        <div class="candidate-detail-content">
            <!-- 候选人头部信息 -->
            <div class="candidate-header">
                <div class="candidate-header-avatar">
                    <div class="avatar-placeholder">
                        ${candidate.name.charAt(0).toUpperCase()}
                    </div>
                </div>
                <div class="candidate-header-info">
                    <h4>${candidate.name}</h4>
                    <p>${candidate.email}</p>
                    <p>申请日期: ${candidate.appliedDate} | 状态: ${candidate.status}</p>
                </div>
            </div>

            <!-- 基本信息 -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <i class="uil uil-user"></i> 基本信息
                </div>
                <div class="detail-section-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <strong>工作经验:</strong> ${candidate.experience}
                        </div>
                        <div>
                            <strong>教育背景:</strong> ${candidate.education}
                        </div>
                        <div>
                            <strong>技能匹配度:</strong> ${candidate.skillsMatch}%
                        </div>
                        <div>
                            <strong>申请状态:</strong> ${candidate.status}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 技能雷达图 -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <i class="uil uil-chart"></i> 技能雷达图
                </div>
                <div class="detail-section-content">
                    <div class="skills-radar">
                        <div class="skills-radar-placeholder">
                            <i class="uil uil-chart-radar"></i>
                            <p>技能雷达图将在这里显示</p>
                            <p>展示候选人在各个技能领域的熟练程度</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 简历内容 -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <i class="uil uil-file-alt"></i> 简历内容
                </div>
                <div class="detail-section-content">
                    <div class="resume-content">
                        <div class="resume-content-placeholder">
                            <i class="uil uil-file-alt"></i>
                            <p>${candidate.resume}</p>
                            <p>这里可以显示完整的简历内容，支持富文本格式...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 面试记录 -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <i class="uil uil-calendar-alt"></i> 面试记录
                </div>
                <div class="detail-section-content">
                    <div class="interview-records">
                        ${candidate.interviews.map(interview => `
                            <div class="interview-record">
                                <div class="interview-record-header">
                                    <span class="interview-date">${interview.date}</span>
                                    <span class="interview-status ${interview.status}">
                                        ${interview.status === 'completed' ? '已完成' : 
                                          interview.status === 'scheduled' ? '已安排' : '已取消'}
                                    </span>
                                </div>
                                <div class="interview-notes">${interview.notes}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function compareCandidate(id) {
    // 打开候选人比较模态框
    document.getElementById('compare-modal').style.display = 'block';
}

function closeCompareModal() {
    document.getElementById('compare-modal').style.display = 'none';
    document.getElementById('compare-results').style.display = 'none';
}

function compareCandidates() {
    const candidate1Id = document.getElementById('candidate1-select').value;
    const candidate2Id = document.getElementById('candidate2-select').value;
    
    if (!candidate1Id || !candidate2Id) {
        alert('请选择两个候选人进行比较');
        return;
    }
    
    if (candidate1Id === candidate2Id) {
        alert('请选择不同的候选人进行比较');
        return;
    }
    
    // 模拟候选人数据 - 实际应用中应该从后端获取
    const candidate1 = {
        name: '候选人A',
        skills: 85,
        experience: '3-5年',
        education: '计算机科学学士',
        status: '面试中'
    };
    
    const candidate2 = {
        name: '候选人B',
        skills: 78,
        experience: '5-8年',
        education: '软件工程硕士',
        status: '已发Offer'
    };
    
    // 显示比较结果
    const compareResults = document.getElementById('compare-results');
    compareResults.innerHTML = generateComparisonTable(candidate1, candidate2);
    compareResults.style.display = 'block';
}

function generateComparisonTable(candidate1, candidate2) {
    return `
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>比较项目</th>
                    <th>${candidate1.name}</th>
                    <th>${candidate2.name}</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>技能匹配度</strong></td>
                    <td class="${candidate1.skills > candidate2.skills ? 'comparison-highlight' : ''}">${candidate1.skills}%</td>
                    <td class="${candidate2.skills > candidate1.skills ? 'comparison-highlight' : ''}">${candidate2.skills}%</td>
                </tr>
                <tr>
                    <td><strong>工作经验</strong></td>
                    <td>${candidate1.experience}</td>
                    <td>${candidate2.experience}</td>
                </tr>
                <tr>
                    <td><strong>教育背景</strong></td>
                    <td>${candidate1.education}</td>
                    <td>${candidate2.education}</td>
                </tr>
                <tr>
                    <td><strong>当前状态</strong></td>
                    <td>${candidate1.status}</td>
                    <td>${candidate2.status}</td>
                </tr>
            </tbody>
        </table>
    `;
}

function scheduleInterview(id) {
    console.log('安排面试:', id);
    // 跳转到面试安排页面
    window.location.href = '{{ url_for("smartrecruit.hr.dashboard.interviews") }}';
}

function closeModal() {
    document.getElementById('candidate-modal').style.display = 'none';
}

function exportCandidates() {
    // 打开导出选项模态框
    document.getElementById('export-modal').style.display = 'block';
}

function closeExportModal() {
    document.getElementById('export-modal').style.display = 'none';
}

function executeExport() {
    const format = document.getElementById('export-format').value;
    const filter = document.getElementById('export-filter').value;
    
    // 获取选中的字段
    const selectedFields = Array.from(document.querySelectorAll('.field-checkbox input:checked'))
        .map(checkbox => checkbox.value);
    
    if (selectedFields.length === 0) {
        alert('请至少选择一个导出字段');
        return;
    }
    
    // 模拟导出过程
    console.log('开始导出...', {
        format: format,
        filter: filter,
        fields: selectedFields
    });
    
    // 显示导出进度
    const exportBtn = document.querySelector('#export-modal .btn-primary');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="uil uil-spinner"></i> 导出中...';
    exportBtn.disabled = true;
    
    // 模拟导出延迟
    setTimeout(() => {
        // 创建下载链接
        const data = generateExportData(selectedFields);
        const blob = new Blob([data], { type: getMimeType(format) });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `candidates_${new Date().toISOString().split('T')[0]}.${getFileExtension(format)}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // 恢复按钮状态
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        
        // 关闭模态框
        closeExportModal();
        
        // 显示成功消息
        alert('导出成功！文件已下载到您的下载文件夹。');
    }, 2000);
}

function generateExportData(fields) {
    // 模拟生成导出数据
    const headers = fields.map(field => {
        const fieldNames = {
            'name': '姓名',
            'email': '邮箱',
            'skills': '技能匹配度',
            'status': '状态',
            'experience': '工作经验',
            'education': '教育背景',
            'applied_date': '申请日期'
        };
        return fieldNames[field] || field;
    });
    
    const data = [
        headers.join(','),
        '张三,zhangsan@example.com,85%,面试中,3-5年,计算机科学学士,2024-01-15',
        '李四,lisi@example.com,78%,已发Offer,5-8年,软件工程硕士,2024-01-10',
        '王五,wangwu@example.com,92%,投递,0-2年,信息管理学士,2024-01-20'
    ];
    
    return data.join('\n');
}

function getMimeType(format) {
    const mimeTypes = {
        'excel': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'csv': 'text/csv',
        'pdf': 'application/pdf'
    };
    return mimeTypes[format] || 'text/plain';
}

function getFileExtension(format) {
    const extensions = {
        'excel': 'xlsx',
        'csv': 'csv',
        'pdf': 'pdf'
    };
    return extensions[format] || 'txt';
}

function bulkActions() {
    document.getElementById('bulk-modal').style.display = 'block';
}

function closeBulkModal() {
    document.getElementById('bulk-modal').style.display = 'none';
}

function bulkScheduleInterview() {
    console.log('批量安排面试');
    closeBulkModal();
}

function bulkSendEmail() {
    console.log('批量发送邮件');
    closeBulkModal();
}

function bulkExport() {
    console.log('批量导出');
    closeBulkModal();
}

function bulkReject() {
    if (confirm('确定要批量拒绝选中的候选人吗？此操作不可撤销。')) {
        console.log('批量拒绝');
        closeBulkModal();
    }
}

function resetFilters() {
    document.getElementById('candidate-search').value = '';
    document.getElementById('status-filter').value = '';
    document.getElementById('skills-filter').value = '';
    filterCandidates();
}

function previousPage() {
    console.log('上一页');
    // 实现分页功能
}

function nextPage() {
    console.log('下一页');
    // 实现分页功能
}

// 点击模态框外部关闭
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
            // 重置比较结果
            const compareResults = document.getElementById('compare-results');
            if (compareResults) {
                compareResults.style.display = 'none';
            }
        }
    });
}

// 按ESC键关闭模态框
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
                // 重置比较结果
                const compareResults = document.getElementById('compare-results');
                if (compareResults) {
                    compareResults.style.display = 'none';
                }
            }
        });
    }
});
</script>
{% endblock %}
