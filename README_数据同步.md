# 数据同步功能说明

## 概述

本项目实现了HR端和求职者端之间的数据自动同步功能，确保两端的招聘信息、申请状态和简历数据保持实时同步。

## 功能特性

### 1. 职位同步
- **HR端发布职位** → 自动同步到求职者端
- **HR端更新职位** → 自动同步到求职者端
- **HR端删除职位** → 相关申请自动处理

### 2. 申请同步
- **求职者提交申请** → 自动同步到HR端
- **HR端更新申请状态** → 自动同步到求职者端
- **申请状态变更** → 实时同步到两端

### 3. 简历同步
- **求职者上传简历** → 自动同步到HR端
- **求职者更新简历** → 自动同步到HR端
- **简历信息变更** → 实时同步到HR端

## 技术实现

### 核心组件

1. **DataSyncService** (`app/sync_service.py`)
   - 数据同步的核心服务类
   - 提供各种同步方法
   - 处理同步状态和日志

2. **同步字段**
   - `Job.last_synced`: 职位最后同步时间
   - `Application.last_synced`: 申请最后同步时间
   - `User.cv_last_synced`: 用户简历最后同步时间

3. **同步管理模块** (`smartrecruit_system/hr_module/sync_management.py`)
   - 提供同步状态查看
   - 支持手动同步操作
   - 显示同步日志

### 同步流程

```
HR发布职位 → 触发同步 → 求职者端可见
求职者申请 → 触发同步 → HR端可见
HR更新状态 → 触发同步 → 求职者端可见
求职者更新简历 → 触发同步 → HR端可见
```

## 使用方法

### 1. 数据库迁移

首次使用需要运行数据库迁移脚本：

```bash
cd scripts
python add_sync_fields.py
```

### 2. 自动同步

系统会自动在以下情况下触发同步：

- HR发布/更新职位时
- 求职者提交申请时
- 求职者更新简历时
- HR更新申请状态时

### 3. 手动同步

HR可以在同步管理页面进行手动同步操作：

- 查看同步状态
- 强制同步所有数据
- 同步特定职位
- 同步特定申请
- 同步特定用户简历

### 4. 访问同步管理

HR用户可以通过以下路径访问同步管理：

```
/smartrecruit/hr/sync/dashboard  # 同步仪表盘
/smartrecruit/hr/sync/status     # 同步状态API
/smartrecruit/hr/sync/logs       # 同步日志
```

## 配置说明

### 环境变量

```bash
# MongoDB连接（可选，用于增强数据存储）
MONGO_URI=mongodb://localhost:27017/applications

# 数据库类型（默认SQLite）
DATABASE_URL=sqlite:///site.db
```

### 数据库配置

系统支持多种数据库：
- **SQLite** (默认，开发环境)
- **MySQL** (生产环境推荐)
- **PostgreSQL** (生产环境推荐)

## 监控和维护

### 1. 同步状态监控

- 查看各表的同步率
- 监控同步失败的情况
- 查看最近的同步活动

### 2. 日志查看

- 同步操作日志
- 错误和警告信息
- 性能统计

### 3. 故障排除

常见问题：
- 同步字段缺失 → 运行迁移脚本
- 同步失败 → 检查数据库连接
- 权限问题 → 确认用户角色

## 性能优化

### 1. 批量同步

- 支持批量同步操作
- 减少数据库查询次数
- 优化同步性能

### 2. 异步处理

- 同步操作不阻塞主流程
- 支持后台同步任务
- 提高用户体验

### 3. 缓存机制

- 缓存同步状态
- 减少重复查询
- 提升响应速度

## 安全考虑

### 1. 权限控制

- 只有HR用户可以管理同步
- 用户只能操作自己的数据
- 防止越权访问

### 2. 数据验证

- 同步前验证数据完整性
- 防止恶意数据注入
- 确保数据一致性

### 3. 审计日志

- 记录所有同步操作
- 追踪数据变更历史
- 支持合规要求

## 扩展功能

### 1. 实时通知

- 同步完成后的实时通知
- 邮件/短信提醒
- 推送通知

### 2. 数据备份

- 同步前自动备份
- 支持数据恢复
- 灾难恢复方案

### 3. 第三方集成

- 支持外部系统集成
- API接口开放
- 数据导出功能

## 故障排除

### 1. 同步失败

```python
# 检查同步状态
from app.sync_service import DataSyncService
status = DataSyncService.get_sync_status()
print(status)
```

### 2. 数据库错误

```bash
# 检查数据库连接
python -c "from app import db; print(db.engine.execute('SELECT 1').fetchone())"
```

### 3. 权限问题

```python
# 检查用户权限
if not getattr(g.user, 'is_hr', False):
    flash('只有HR用户才能访问此页面。', 'danger')
```

## 联系支持

如果遇到问题，请：

1. 查看应用日志 (`app.log`)
2. 检查同步状态页面
3. 运行数据库迁移脚本
4. 联系技术支持团队

## 更新日志

### v1.0.0 (2024-01-15)
- 初始版本发布
- 支持基本的职位、申请、简历同步
- 提供同步管理界面
- 支持手动和自动同步

---

**注意**: 本功能需要数据库支持，请确保在运行前完成数据库迁移。
